var __extends=this&&this.__extends||function(){var s=function(e,t){s=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)if(t.hasOwnProperty(i))e[i]=t[i]};return s(e,t)};return function(e,t){s(e,t);function i(){this.constructor=e}e.prototype=t===null?Object.create(t):(i.prototype=t.prototype,new i)}}();var suncore;(function(e){var p;(function(e){e[e["MIN"]=0]="MIN";e[e["PRIORITY_0"]=1]="PRIORITY_0";e[e["PRIORITY_HIGH"]=2]="PRIORITY_HIGH";e[e["PRIORITY_NOR"]=3]="PRIORITY_NOR";e[e["PRIORITY_LOW"]=4]="PRIORITY_LOW";e[e["PRIORITY_LAZY"]=5]="PRIORITY_LAZY";e[e["PRIORITY_TRIGGER"]=6]="PRIORITY_TRIGGER";e[e["PRIORITY_TASK"]=7]="PRIORITY_TASK";e[e["MAX"]=8]="MAX"})(p=e.MessagePriorityEnum||(e.MessagePriorityEnum={}));var M;(function(e){e[e["MIN"]=0]="MIN";e[e["SYSTEM"]=0]="SYSTEM";e[e["CUSTOM"]=1]="CUSTOM";e[e["TIMELINE"]=2]="TIMELINE";e[e["MAX"]=3]="MAX"})(M=e.ModuleEnum||(e.ModuleEnum={}));var r;(function(e){e[e["NSL_MSG_ID_BEGIN"]=1]="NSL_MSG_ID_BEGIN";e[e["NSL_MSG_ID_END"]=10]="NSL_MSG_ID_END";e[e["MMI_MSG_ID_BEGIN"]=10]="MMI_MSG_ID_BEGIN";e[e["MMI_MSG_ID_END"]=100]="MMI_MSG_ID_END";e[e["CUI_MSG_ID_BEGIN"]=100]="CUI_MSG_ID_BEGIN";e[e["CUI_MSG_ID_END"]=200]="CUI_MSG_ID_END";e[e["GUI_MSG_ID_BEGIN"]=200]="GUI_MSG_ID_BEGIN";e[e["GUI_MSG_ID_END"]=400]="GUI_MSG_ID_END";e[e["L4C_MSG_ID_BEGIN"]=400]="L4C_MSG_ID_BEGIN";e[e["L4C_MSG_ID_END"]=700]="L4C_MSG_ID_END"})(r=e.MsgQIdEnum||(e.MsgQIdEnum={}));var l;(function(e){e[e["NIL"]=-1]="NIL";e[e["KAL"]=0]="KAL";e[e["MMI"]=1]="MMI";e[e["L4C"]=2]="L4C";e[e["CUI"]=3]="CUI";e[e["GUI"]=4]="GUI";e[e["NSL"]=5]="NSL";e[e["ANY"]=6]="ANY"})(l=e.MsgQModEnum||(e.MsgQModEnum={}));var t=function(t){__extends(e,t);function e(){var e=t!==null&&t.apply(this,arguments)||this;e.$done=false;e.$running=false;return e}e.prototype.cancel=function(){};Object.defineProperty(e.prototype,"done",{get:function(){return this.$done},set:function(e){if(this.$done!==e){this.$done=e;if(e===true){this.cancel()}}},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"running",{get:function(){return this.$running},set:function(e){this.$running=e},enumerable:true,configurable:true});return e}(puremvc.Notifier);e.AbstractTask=t;var i=function(t){__extends(e,t);function e(){var e=t!==null&&t.apply(this,arguments)||this;e.$running=false;return e}e.prototype.run=function(){if(this.$running===true){suncom.Logger.warn(suncom.DebugMode.ANY,"服务["+suncom.Common.getQualifiedClassName(this)+"]己运行");return}this.$running=true;this.$onRun();suncom.Test.assertTrue(this.$running);suncom.Test.assertFalse(this.facade.hasObserver(I.ENTER_FRAME,null,this),"请重写$frameLoop方法来替代ENTER_FRAME事件");if(this.$frameLoop!==e.prototype.$frameLoop){this.facade.registerObserver(I.ENTER_FRAME,this.$onEnterFrame,this,false,suncom.EventPriorityEnum.EGL)}};e.prototype.stop=function(){if(this.$running===false){suncom.Logger.warn(suncom.DebugMode.ANY,"服务["+suncom.Common.getQualifiedClassName(this)+"]未运行");return}this.$running=false;this.$onStop();suncom.Test.assertFalse(this.$running);if(this.$frameLoop!==e.prototype.$frameLoop){this.facade.removeObserver(I.ENTER_FRAME,this.$onEnterFrame,this)}};e.prototype.$onEnterFrame=function(){if(this.$running===true){this.$frameLoop()}};e.prototype.$frameLoop=function(){};Object.defineProperty(e.prototype,"running",{get:function(){return this.$running},enumerable:true,configurable:true});return e}(puremvc.Notifier);e.BaseService=i;var s=function(t){__extends(e,t);function e(){var e=t.call(this,l.KAL)||this;e.$delta=0;e.$runTime=0;e.$localTime=(new Date).valueOf();Laya.timer.frameLoop(1,e,e.$onFrameLoop);return e}e.prototype.destroy=function(){if(this.$destroyed===true){return}t.prototype.destroy.call(this);Laya.timer.clear(this,this.$onFrameLoop)};e.prototype.$onFrameLoop=function(){var e=this.$localTime;this.$localTime=(new Date).valueOf();this.$delta=this.$localTime-e;if(this.$delta>0){this.$runTime+=this.$delta;this.$lapse(this.$delta)}};e.prototype.$lapse=function(e){if(_.isModulePaused(M.CUSTOM)===false){g.timeStamp.lapse(e)}if(_.isModulePaused(M.TIMELINE)===false){g.timeline.lapse(e)}this.facade.sendNotification(I.MSG_Q_BUSINESS,l.NSL);this.facade.sendNotification(I.PHYSICS_PREPARE);this.facade.sendNotification(I.PHYSICS_FRAME);g.timerManager.executeTimer();this.facade.sendNotification(I.ENTER_FRAME);g.messageManager!==null&&g.messageManager.dealMessage();g.messageManager!==null&&g.messageManager.classifyMessages0();this.facade.sendNotification(I.LATER_FRAME);this.facade.sendNotification(I.MSG_Q_BUSINESS)};e.prototype.getTime=function(){return this.$runTime};e.prototype.getDelta=function(){return this.$delta};return e}(puremvc.Notifier);e.Engine=s;var n=function(){function e(){this.$queues=[];for(var e=M.MIN;e<M.MAX;e++){this.$queues[e]=new o(e)}}e.prototype.putMessage=function(e){this.$queues[e.mod].putMessage(e)};e.prototype.dealMessage=function(){for(var e=M.MIN;e<M.MAX;e++){if(_.isModulePaused(e)===false){this.$queues[e].dealMessage()}}};e.prototype.classifyMessages0=function(){for(var e=M.MIN;e<M.MAX;e++){if(_.isModuleStopped(e)===false){this.$queues[e].classifyMessages0()}}};e.prototype.clearMessages=function(e){this.$queues[e].clearMessages()};e.prototype.cancelTaskByGroupId=function(e,t){this.$queues[e].cancelTaskByGroupId(e,t)};return e}();e.MessageManager=n;var o=function(){function e(e){this.$tasks=[];this.$queues=[];this.$messages0=[];this.$mod=e;for(var t=p.MIN;t<p.MAX;t++){this.$queues[t]=[]}}e.prototype.putMessage=function(e){this.$messages0.push(e)};e.prototype.dealMessage=function(){var e=0;var t=0;for(var i=p.MIN;i<p.MAX;i++){var s=void 0;if(i===p.PRIORITY_TASK){s=this.$tasks}else{s=this.$queues[i]}if(s.length===0||i===p.PRIORITY_LAZY){continue}if(i===p.PRIORITY_TASK){for(var r=this.$tasks.length-1;r>-1;r--){var n=this.$tasks[r];if(n.length>0&&this.$dealTaskMessage(n[0])===true){n.shift();e++}if(n.length>1){t+=n.length-1}else if(n.length===0){this.$tasks.splice(r,1)}}}else if(i===p.PRIORITY_TRIGGER){var o={canceled:false};while(s.length>0&&this.$dealTriggerMessage(s[0],o)===true){s.shift();if(o.canceled===false){e++}}}else{var u=0;var a=this.$getDealCountByPriority(i);for(;s.length>0&&(a===0||u<a);u++){if(this.$dealCustomMessage(s.shift())===false){u--}}e+=u}t+=s.length}if(t===0&&e===0&&this.$messages0.length===0){var s=this.$queues[p.PRIORITY_LAZY];if(s.length>0){this.$dealCustomMessage(s.shift());e++}}};e.prototype.$dealTaskMessage=function(e){var t=e.task;if(t.running===false){t.running=true;if(t.run()===true){t.done=true}}return t.done===true};e.prototype.$dealTriggerMessage=function(e,t){if(e.timeout>_.getModuleTimestamp(this.$mod)){return false}t.canceled=e.handler.run()===false;return true};e.prototype.$dealCustomMessage=function(e){return e.handler.run()!==false};e.prototype.$getDealCountByPriority=function(e){if(e===p.PRIORITY_0){return 0}if(e===p.PRIORITY_HIGH){return 10}if(e===p.PRIORITY_NOR){return 3}if(e===p.PRIORITY_LOW){return 1}throw Error("错误的消息优先级")};e.prototype.classifyMessages0=function(){while(this.$messages0.length>0){var e=this.$messages0.shift();if(e.priority===p.PRIORITY_TASK){this.$addTaskMessage(e)}else if(e.priority===p.PRIORITY_TRIGGER){this.$addTriggerMessage(e)}else{this.$queues[e.priority].push(e)}}};e.prototype.$addTriggerMessage=function(e){var t=this.$queues[p.PRIORITY_TRIGGER];var i=0;var s=0;var r=t.length-1;var n=-1;while(r-i>1){s=Math.floor((i+r)*.5);if(t[s].timeout<=e.timeout){i=s}else if(t[s].timeout>e.timeout){r=s}else{break}}for(var o=i;o<=r;o++){if(t[o].timeout>e.timeout){n=o;break}}if(n<0){t.push(e)}else{t.splice(n,0,e)}};e.prototype.$addTaskMessage=function(e){var t=-1;for(var i=0;i<this.$tasks.length;i++){var s=this.$tasks[i];if(s.length>0&&s[0].groupId===e.groupId){t=i;break}}if(t===-1){this.$tasks.unshift([e])}else{this.$tasks[t].push(e)}};e.prototype.clearMessages=function(){while(this.$messages0.length>0){this.$cancelMessage(this.$messages0.shift())}for(var e=0;e<this.$tasks.length;e++){var t=this.$tasks[e];while(t.length>0){this.$cancelMessage(t.shift())}}for(var i=p.MIN;i<p.MAX;i++){var s=this.$queues[i];while(s.length>0){this.$cancelMessage(s.shift())}}};e.prototype.$cancelMessage=function(e){if(e.priority===p.PRIORITY_TASK){e.task.done=true}};e.prototype.cancelTaskByGroupId=function(e,t){for(var i=0;i<this.$tasks.length;i++){var s=this.$tasks[i];if(s.length>0&&s[0].groupId===t){while(s.length>0){s.shift().task.done=true}break}}};return e}();e.MessageQueue=o;var u=function(e){__extends(t,e);function t(){return e!==null&&e.apply(this,arguments)||this}t.prototype.$onRun=function(){h.setModuleActive(this.msgQMod,true);this.facade.registerObserver(I.MSG_Q_BUSINESS,this.$onMsgQBusiness,this)};t.prototype.$onStop=function(){h.setModuleActive(this.msgQMod,false);this.facade.removeObserver(I.MSG_Q_BUSINESS,this.$onMsgQBusiness,this)};t.prototype.$onMsgQBusiness=function(e){var t=null;if(e===void 0||e===this.msgQMod){while(true){if(e===l.NSL){t=h.fetch(l.NSL,2)}else if(this.msgQMod===l.NSL){t=h.fetch(l.NSL,1)}else{t=h.fetch(this.msgQMod)}if(t===null){break}this.$dealMsgQMsg(t)}h.seqId++}};return t}(i);e.MsgQService=u;var a=function(e){__extends(t,e);function t(){return e!==null&&e.apply(this,arguments)||this}t.prototype.execute=function(e,t){suncom.Test.expect(t).interpret("应当为参数 stop 指定有效值").toBeBoolean();if(t===true){if(_.isModuleStopped(e)===true){suncom.Logger.error(suncom.DebugMode.ANY,"模块 "+M[e]+" 己经停止！！！");return}}else if(_.isModulePaused(e)===true){suncom.Logger.error(suncom.DebugMode.ANY,"模块 "+M[e]+" 己经暂停！！！");return}else if(e===M.SYSTEM){suncom.Logger.error(suncom.DebugMode.ANY,"无法暂停 "+M[e]+" 模块！！！");return}if(e===M.TIMELINE){g.timeline.pause(t)}else if(e===M.CUSTOM){g.timeStamp.pause(t)}if(t===false){return}if(e===M.SYSTEM){if(_.isModuleStopped(M.TIMELINE)===false||_.isModuleStopped(M.CUSTOM)===false){suncom.Test.notExpected("SYSTEM 不能停止因为 CUSTOM 或 TIMELINE 依然在运行");return}}g.timerManager.clearTimer(e);g.messageManager.clearMessages(e);if(e===M.TIMELINE){g.timeline=null}else if(e===M.CUSTOM){g.timeStamp=null}else{g.engine.destroy();g.engine=null}if(e===M.SYSTEM){g.timerManager=null;g.messageManager=null}};return t}(puremvc.SimpleCommand);e.PauseTimelineCommand=a;var f=function(i){__extends(e,i);function e(e){var t=i.call(this)||this;t.$handler=e;return t}e.prototype.run=function(){this.$handler.run();return true};return e}(t);e.SimpleTask=f;var c=function(e){__extends(t,e);function t(){return e!==null&&e.apply(this,arguments)||this}t.prototype.execute=function(e,t){suncom.Test.expect(t).interpret("应当为参数 pause 指定有效值").toBeBoolean();if(_.isModulePaused(e)===false){suncom.Logger.error(suncom.DebugMode.ANY,"模块 "+M[e]+" 己经启动！！！");return}if(e===M.SYSTEM&&g.engine===null){g.timerManager=new d;g.messageManager=new n}if(e===M.TIMELINE){if(g.timeline===null){g.timeline=new m}g.timeline.resume(t)}else if(e===M.CUSTOM){if(g.timeStamp===null){g.timeStamp=new m}g.timeStamp.resume(t)}else if(e===M.SYSTEM){if(g.engine===null){g.engine=new s}}};return t}(puremvc.SimpleCommand);e.StartTimelineCommand=c;var m=function(){function e(){this.$runTime=0;this.$paused=true;this.$stopped=true}e.prototype.lapse=function(e){this.$runTime+=e};e.prototype.pause=function(e){this.$paused=true;this.$stopped=e};e.prototype.resume=function(e){this.$paused=e;this.$stopped=false};e.prototype.getTime=function(){return this.$runTime};Object.defineProperty(e.prototype,"paused",{get:function(){return this.$paused},enumerable:true,configurable:true});Object.defineProperty(e.prototype,"stopped",{get:function(){return this.$stopped},enumerable:true,configurable:true});return e}();e.Timeline=m;var d=function(){function e(){this.$seedId=0;this.$timers=[];this.$timerMap={};for(var e=M.MIN;e<M.MAX;e++){this.$timers[e]=[]}}e.prototype.$createNewTimerId=function(){this.$seedId++;return this.$seedId};e.prototype.executeTimer=function(){for(var e=M.MIN;e<M.MAX;e++){if(_.isModulePaused(e)===false){var t=this.$timers[e];var i=_.getModuleTimestamp(e);while(t.length>0){var s=t[0];if(s.active===true){if(s.timeout>i){break}if(s.real===true){s.count++}else{s.count=suncom.Common.min(Math.floor((i-s.timestamp)/s.delay),s.loops)}}if(s.active===false||s.loops>0&&s.count>=s.loops){delete this.$timerMap[s.timerId]}else{this.addTimer(s.mod,s.delay,s.method,s.caller,s.loops,s.real,s.timerId,s.timestamp,s.timeout,s.count)}t.shift();if(s.active===true){s.method.call(s.caller,s.count,s.loops)}}}}};e.prototype.addTimer=function(e,t,i,s,r,n,o,u,a,l){if(r===void 0){r=1}if(n===void 0){n=false}if(o===void 0){o=0}if(u===void 0){u=-1}if(a===void 0){a=-1}if(l===void 0){l=0}var f=_.getModuleTimestamp(e);if(o===0){o=this.$createNewTimerId()}if(u===-1){u=f}if(a===-1){a=f}if(t<1){t=1}var c=0;if(n===true){c=(f-a)%t}else{c=(f-u)%t}a=f+t-c;var m={mod:e,active:true,delay:t,method:i,caller:s,real:n,count:l,loops:r,timerId:o,timestamp:u,timeout:a};var p=this.$timers[e];var M=-1;var d=0;var g=0;var h=p.length-1;while(h-d>1){g=Math.floor((d+h)*.5);if(p[g].timeout<=a){d=g}else if(p[g].timeout>a){h=g}else{break}}for(var I=d;I<=h;I++){if(p[I].timeout>a){M=I;break}}if(M<0){p.push(m)}else{p.splice(M,0,m)}this.$timerMap[o]=m;return o};e.prototype.removeTimer=function(e){if(e>0&&this.$timerMap[e]!==void 0){this.$timerMap[e].active=false}return 0};e.prototype.clearTimer=function(e){var t=this.$timers[e];while(t.length>0){var i=t.pop();delete this.$timerMap[i.timerId]}};return e}();e.TimerManager=d;var g;(function(e){e.engine=null;e.timeline=null;e.timeStamp=null;e.timerManager=null;e.messageManager=null})(g=e.M||(e.M={}));var h;(function(n){var o={};var i={};n.seqId=1;function e(e,t,i){if(a(e)===false){suncom.Logger.warn(suncom.DebugMode.ANY,"消息发送失败，模块己暂停 mod:"+l[e]);return}if(u(e,t)===false){suncom.Logger.warn(suncom.DebugMode.ANY,"消息发送失败，消息ID非法 mod:"+e+", id:"+t);return}var s=o[e]||null;if(s===null){s=o[e]=[]}var r={dst:e,seqId:n.seqId,id:t,data:i};s.push(r)}n.send=e;function t(e,t){var i=o[e]||null;if(i===null||i.length===0){return null}for(var s=0;s<i.length;s++){var r=i[s];if(e===l.NSL||r.seqId<n.seqId){if(t===void 0||r.id===t){i.splice(s,1);return r}}}return null}n.fetch=t;function u(e,t){var i=suncom.Common.MIN_SAFE_INTEGER;var s=suncom.Common.MAX_SAFE_INTEGER;if(e===l.MMI){i=r.MMI_MSG_ID_BEGIN;s=r.MMI_MSG_ID_END}else if(e===l.CUI){i=r.CUI_MSG_ID_BEGIN;s=r.CUI_MSG_ID_END}else if(e===l.GUI){i=r.GUI_MSG_ID_BEGIN;s=r.GUI_MSG_ID_END}else if(e===l.L4C){i=r.L4C_MSG_ID_BEGIN;s=r.L4C_MSG_ID_END}else if(e===l.NSL){i=r.NSL_MSG_ID_BEGIN;s=r.NSL_MSG_ID_END}else{suncom.Test.notExpected("未知的消息范围 mod:"+e)}return t>=i&&t<s}function a(e){return i[e]===true}n.isModuleActive=a;function s(e,t){i[e]=t;if(t===false){delete o[e]}}n.setModuleActive=s})(h=e.MsgQ||(e.MsgQ={}));var I;(function(e){e.STARTUP="suncore.NotifyKey.STARTUP";e.SHUTDOWN="suncore.NotifyKey.SHUTDOWN";e.START_TIMELINE="suncore.NotifyKey.START_TIMELINE";e.PAUSE_TIMELINE="suncore.NotifyKey.PAUSE_TIMELINE";e.PHYSICS_FRAME="suncore.NotifyKey.PHYSICS_FRAME";e.PHYSICS_PREPARE="suncore.NotifyKey.PHYSICS_PREPARE";e.ENTER_FRAME="suncore.NotifyKey.ENTER_FRAME";e.LATER_FRAME="suncore.NotifyKey.LATER_FRAME";e.MSG_Q_BUSINESS="suncore.NotifyKey.MSG_Q_BUSINESS"})(I=e.NotifyKey||(e.NotifyKey={}));var _;(function(o){var e=1e3;function r(){e++;return e}function t(e){if(e===M.TIMELINE){if(g.timeline===null||g.timeline.stopped===true){return true}}else if(e===M.CUSTOM){if(g.timeStamp===null||g.timeStamp.stopped===true){return true}}else if(g.engine===null){return true}return false}o.isModuleStopped=t;function i(e){if(t(e)===true){return true}if(e===M.TIMELINE){return g.timeline.paused}else if(e===M.CUSTOM){return g.timeStamp.paused}return false}o.isModulePaused=i;function s(){if(t(M.SYSTEM)===false){return g.engine.getDelta()}else{suncom.Logger.error(suncom.DebugMode.ANY,"尝试获取帧时间间隔，但系统模块己停止！！！")}}o.getDelta=s;function n(e){if(t(e)===false){if(e===M.TIMELINE){return g.timeline.getTime()}else if(e===M.CUSTOM){return g.timeStamp.getTime()}return g.engine.getTime()}else{suncom.Logger.error(suncom.DebugMode.ANY,"尝试获取时间戳，但模块 "+M[e]+" 己停止！！！")}}o.getModuleTimestamp=n;function u(e,t,i){if(o.isModuleStopped(e)===false){if(t===-1){t=r()}else if(t>1e3){suncom.Test.notExpected("自定义的Task GroupId不允许超过1000")}var s={mod:e,task:i,groupId:t,priority:p.PRIORITY_TASK};g.messageManager.putMessage(s)}else{t=-1;suncom.Logger.error(suncom.DebugMode.ANY,"尝试添加任务，但模块 "+M[e]+" 己停止！！！")}return t}o.addTask=u;function a(e,t){g.messageManager.cancelTaskByGroupId(e,t)}o.cancelTaskByGroupId=a;function l(e,t,i){if(o.isModuleStopped(e)===false){var s={mod:e,handler:i,timeout:o.getModuleTimestamp(e)+t,priority:p.PRIORITY_TRIGGER};g.messageManager.putMessage(s)}else{suncom.Logger.error(suncom.DebugMode.ANY,"尝试添加触发器，但模块 "+M[e]+" 己停止！！！")}}o.addTrigger=l;function f(e,t,i){if(o.isModuleStopped(e)===false){var s={mod:e,handler:i,priority:t};g.messageManager.putMessage(s)}else{suncom.Logger.error(suncom.DebugMode.ANY,"尝试添加Message消息，但模块 "+M[e]+" 己停止！！！")}}o.addMessage=f;function c(e,t,i,s,r,n){if(r===void 0){r=1}if(n===void 0){n=false}if(o.isModuleStopped(e)===false){return g.timerManager.addTimer(e,t,i,s,r,n)}else{suncom.Logger.error(suncom.DebugMode.ANY,"尝试添加定时器，但模块 "+M[e]+" 己停止！！！")}}o.addTimer=c;function m(e){return g.timerManager.removeTimer(e)}o.removeTimer=m})(_=e.System||(e.System={}))})(suncore||(suncore={}));